{% extends 'tracker/base.html' %}
{% load widget_tweaks %}

{% block title %}{% if form.instance.pk %}Edit{% else %}Add{% endif %} Expense{% endblock %}
{% block header_title %}{% if form.instance.pk %}Edit Expense{% else %}Add New Expense{% endif %}{% endblock %}</h3>
{% block header_subtitle %}{% if form.instance.pk %}Update expense details{% else %}Record new expense{% endif %}</p>{% endblock %}

{% block extra_css %}
<style>
    .category-option {
        transition: all 0.3s ease;
    }

    .category-option:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Stats Banner -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="stat-card card p-6 rounded-xl">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-rose-900/50 rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-chart-line text-rose-400 text-xl"></i>
                </div>
                <div>
                    <p class="text-slate-400 text-sm">This Month</p>
                    <h3 class="text-2xl font-bold text-rose-400">${{ month_expenses|default:"0"|floatformat:2 }}</h3>
                </div>
            </div>
        </div>

        <div class="stat-card card p-6 rounded-xl">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-violet-900/50 rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-calendar-alt text-violet-400 text-xl"></i>
                </div>
                <div>
                    <p class="text-slate-400 text-sm">Daily Average</p>
                    <h3 class="text-2xl font-bold text-violet-400">${{ daily_avg|default:"0"|floatformat:2 }}</h3>
                </div>
            </div>
        </div>

        <div class="stat-card card p-6 rounded-xl">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-emerald-900/50 rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-bullseye text-emerald-400 text-xl"></i>
                </div>
                <div>
                    <p class="text-slate-400 text-sm">Budget Remaining</p>
                    <h3 class="text-2xl font-bold {% if budget_remaining >= 0 %}text-emerald-400{% else %}text-rose-400{% endif %}">
                        ${{ budget_remaining|default:"2000"|floatformat:2 }}
                    </h3>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Column - Form -->
        <div class="lg:col-span-2">
            <div class="card rounded-xl p-8">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-xl font-bold">
                            <i class="fas fa-receipt text-rose-400 mr-2"></i>
                            {% if form.instance.pk %}Edit Expense Record{% else %}Record New Expense{% endif %}
                        </h3>
                        <p class="text-slate-400 text-sm mt-1">
                            {% if form.instance.pk %}
                            Last updated: {{ form.instance.date|date:"M d, Y" }}
                            {% else %}
                            Track your spending to optimize your finances
                            {% endif %}
                        </p>
                    </div>
                    <div class="text-right">
                        <span class="px-3 py-1 bg-rose-900/30 text-rose-400 rounded-full text-sm">
                            <i class="fas fa-exclamation-circle mr-1"></i> Expense
                        </span>
                    </div>
                </div>

                <form method="post" class="space-y-8" id="expenseForm">
                    {% csrf_token %}

                    <!-- Form Errors -->
                    {% if form.errors %}
                    <div class="p-6 bg-rose-900/50 border border-rose-800 rounded-lg">
                        <div class="flex items-center mb-3">
                            <i class="fas fa-exclamation-triangle text-rose-400 text-xl mr-3"></i>
                            <h4 class="text-rose-300 font-medium text-lg">Please correct the errors below</h4>
                        </div>
                        <ul class="mt-2 text-sm text-rose-400 space-y-1">
                            {% for field in form %}
                                {% for error in field.errors %}
                                    <li><span class="font-medium">{{ field.label }}:</span> {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                            {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- Section 1: Expense Details -->
                    <div class="space-y-6">
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 bg-rose-900/50 rounded-full flex items-center justify-center">
                                <i class="fas fa-info-circle text-rose-400"></i>
                            </div>
                            <h4 class="text-lg font-semibold">Expense Details</h4>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Name Field -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-slate-300">
                                    <i class="fas fa-tag mr-2"></i>Expense Name
                                </label>
                                {% render_field form.name class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:border-transparent" placeholder="e.g., Groceries, Rent, Utilities" %}
                                <p class="text-xs text-slate-500">Give this expense a clear name</p>
                            </div>

                            <!-- Amount Field -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-slate-300">
                                    <i class="fas fa-money-bill-wave mr-2"></i>Amount Spent
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400">$</span>
                                    {% render_field form.worth class="w-full bg-slate-800 border border-slate-700 rounded-lg pl-10 pr-4 py-3 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:border-transparent" placeholder="0.00" id="amountInput" %}
                                </div>
                                <div class="flex items-center justify-between">
                                    <p class="text-xs text-slate-500">Enter the exact amount spent</p>
                                    <span id="budgetImpact" class="text-xs"></span>
                                </div>
                            </div>

                            <!-- Date Field -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-slate-300">
                                    <i class="fas fa-calendar-alt mr-2"></i>Date
                                </label>
                                {% render_field form.date class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:border-transparent" %}
                                <p class="text-xs text-slate-500">When did you make this expense?</p>
                            </div>

                            <!-- Category Field -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-slate-300">
                                    <i class="fas fa-layer-group mr-2"></i>Category
                                </label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button type="button" onclick="setCategory('Business')" class="category-option p-3 bg-blue-900/20 hover:bg-blue-900/30 border border-blue-800/30 rounded-lg text-center">
                                        <i class="fas fa-briefcase text-blue-400 text-lg mb-1"></i>
                                        <p class="text-sm font-medium">Business</p>
                                    </button>
                                    <button type="button" onclick="setCategory('Personal')" class="category-option p-3 bg-purple-900/20 hover:bg-purple-900/30 border border-purple-800/30 rounded-lg text-center">
                                        <i class="fas fa-user text-purple-400 text-lg mb-1"></i>
                                        <p class="text-sm font-medium">Personal</p>
                                    </button>
                                    <button type="button" onclick="setCategory('Investment')" class="category-option p-3 bg-emerald-900/20 hover:bg-emerald-900/30 border border-emerald-800/30 rounded-lg text-center">
                                        <i class="fas fa-chart-line text-emerald-400 text-lg mb-1"></i>
                                        <p class="text-sm font-medium">Investment</p>
                                    </button>
                                    <button type="button" onclick="setCategory('Other')" class="category-option p-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg text-center">
                                        <i class="fas fa-ellipsis-h text-slate-400 text-lg mb-1"></i>
                                        <p class="text-sm font-medium">Other</p>
                                    </button>
                                </div>
                                <input type="hidden" id="categoryInput" name="category">
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Additional Details -->
                    <div class="space-y-6">
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 bg-violet-900/50 rounded-full flex items-center justify-center">
                                <i class="fas fa-file-alt text-violet-400"></i>
                            </div>
                            <h4 class="text-lg font-semibold">Additional Details</h4>
                        </div>

                        <!-- Description Field -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-slate-300">
                                <i class="fas fa-sticky-note mr-2"></i>Description & Notes
                            </label>
                            {% render_field form.description class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:border-transparent" rows="4" placeholder="Add any notes about this expense..." %}
                            <div class="flex justify-between items-center">
                                <p class="text-xs text-slate-500">Optional: Add details about this expense</p>
                                <span id="charCount" class="text-xs text-slate-500">0/500</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold">Quick Actions</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button type="button" class="quick-action-btn p-4 rounded-lg text-center" onclick="setAmount(50)">
                                <i class="fas fa-coins text-rose-400 text-lg mb-2"></i>
                                <p class="font-medium">Add $50</p>
                                <p class="text-xs text-slate-400">Quick expense</p>
                            </button>

                            <button type="button" class="quick-action-btn p-4 rounded-lg text-center" onclick="setTodayDate()">
                                <i class="fas fa-calendar-day text-violet-400 text-lg mb-2"></i>
                                <p class="font-medium">Today's Date</p>
                                <p class="text-xs text-slate-400">Set to current</p>
                            </button>

                            <button type="button" class="quick-action-btn p-4 rounded-lg text-center" onclick="clearForm()">
                                <i class="fas fa-eraser text-slate-400 text-lg mb-2"></i>
                                <p class="font-medium">Clear Form</p>
                                <p class="text-xs text-slate-400">Reset all fields</p>
                            </button>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="pt-6 border-t border-slate-800">
                        <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0">
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="addAnother" class="w-4 h-4 bg-slate-800 border-slate-700 rounded focus:ring-rose-500">
                                <label for="addAnother" class="text-sm text-slate-400">Add another expense after saving</label>
                            </div>

                            <div class="flex items-center space-x-4">
                                <a href="{% url 'expenses-list' %}"
                                   class="px-6 py-3 bg-slate-800 hover:bg-slate-700 rounded-lg font-medium transition-colors flex items-center">
                                    <i class="fas fa-times mr-2"></i>Cancel
                                </a>
                                <button type="submit"
                                        class="btn-primary px-8 py-3 flex items-center bg-gradient-to-r from-rose-600 to-pink-600">
                                    <i class="fas fa-save mr-2"></i>
                                    {% if form.instance.pk %}Update Expense{% else %}Record Expense{% endif %}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Right Column - Sidebar -->
        <div class="space-y-6">
            <!-- Budget Overview -->
            <div class="preview-card card rounded-xl p-6">
                <h4 class="text-lg font-semibold mb-4">
                    <i class="fas fa-chart-pie mr-2"></i>Budget Overview
                </h4>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm text-slate-400">Monthly Budget</span>
                            <span class="text-sm font-medium">${{ budget|default:"2000" }}</span>
                        </div>
                        <div class="w-full bg-slate-800 rounded-full h-2">
                            <div class="bg-emerald-500 h-2 rounded-full" style="width: {{ budget_percentage|default:"75" }}%"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-3 bg-slate-800/30 rounded-lg">
                            <p class="text-xs text-slate-400">Spent</p>
                            <p class="font-medium text-rose-400">${{ month_expenses|default:"0" }}</p>
                        </div>
                        <div class="p-3 bg-slate-800/30 rounded-lg">
                            <p class="text-xs text-slate-400">Remaining</p>
                            <p class="font-medium text-emerald-400">${{ budget_remaining|default:"2000" }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expense Categories -->
            <div class="card rounded-xl p-6">
                <h4 class="text-lg font-semibold mb-4">
                    <i class="fas fa-tags mr-2"></i>Expense Categories
                </h4>
                <div class="space-y-3">
                    <div class="flex items-center justify-between p-2">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-900/30 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-briefcase text-blue-400 text-sm"></i>
                            </div>
                            <span class="text-sm">Business</span>
                        </div>
                        <span class="text-sm text-slate-400">35%</span>
                    </div>
                    <div class="flex items-center justify-between p-2">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-purple-900/30 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-user text-purple-400 text-sm"></i>
                            </div>
                            <span class="text-sm">Personal</span>
                        </div>
                        <span class="text-sm text-slate-400">45%</span>
                    </div>
                    <div class="flex items-center justify-between p-2">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-emerald-900/30 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-chart-line text-emerald-400 text-sm"></i>
                            </div>
                            <span class="text-sm">Investment</span>
                        </div>
                        <span class="text-sm text-slate-400">15%</span>
                    </div>
                    <div class="flex items-center justify-between p-2">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-slate-700 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-ellipsis-h text-slate-400 text-sm"></i>
                            </div>
                            <span class="text-sm">Other</span>
                        </div>
                        <span class="text-sm text-slate-400">5%</span>
                    </div>
                </div>
            </div>

            <!-- Quick Tips -->
            <div class="card rounded-xl p-6">
                <h4 class="text-lg font-semibold mb-4">
                    <i class="fas fa-lightbulb mr-2"></i>Smart Spending
                </h4>
                <div class="space-y-3">
                    <div class="flex items-start space-x-3">
                        <i class="fas fa-check text-emerald-400 mt-1"></i>
                        <div>
                            <p class="text-sm font-medium">Track Regularly</p>
                            <p class="text-xs text-slate-400">Record expenses daily for accuracy</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-3">
                        <i class="fas fa-check text-emerald-400 mt-1"></i>
                        <div>
                            <p class="text-sm font-medium">Categorize Wisely</p>
                            <p class="text-xs text-slate-400">Helps identify spending patterns</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-3">
                        <i class="fas fa-check text-emerald-400 mt-1"></i>
                        <div>
                            <p class="text-sm font-medium">Set Limits</p>
                            <p class="text-xs text-slate-400">Establish budget for each category</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Expenses -->
            <div class="card rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg font-semibold">
                        <i class="fas fa-history mr-2"></i>Recent Expenses
                    </h4>
                    <span class="text-xs text-rose-400">{{ recent_count }} records</span>
                </div>
                <div class="space-y-3">
                    {% for expense in recent_expenses|slice:":3" %}
                    <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg">
                        <div>
                            <p class="font-medium text-sm">{{ expense.name|truncatechars:20 }}</p>
                            <p class="text-xs text-slate-400">{{ expense.date|date:"M d" }}</p>
                        </div>
                        <span class="font-bold text-rose-400">${{ expense.worth }}</span>
                    </div>
                    {% empty %}
                    <p class="text-slate-400 text-center py-4 text-sm">No recent expenses</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const amountInput = document.getElementById('amountInput');
    const descriptionTextarea = document.querySelector('textarea[name="description"]');
    const charCount = document.getElementById('charCount');
    const budgetImpact = document.getElementById('budgetImpact');

    // Update budget impact
    amountInput.addEventListener('input', function() {
        const value = this.value || '0';
        const numValue = parseFloat(value.replace(/[^0-9.]/g, '')) || 0;

        // Update budget impact
        const budget = {{ budget|default:"2000" }};
        const spent = {{ month_expenses|default:"0" }};
        const newTotal = spent + numValue;
        const remaining = budget - newTotal;

        if (remaining >= 0) {
            budgetImpact.textContent = "$" + remaining.toFixed(2) + " remaining";
            budgetImpact.className = "text-xs text-emerald-400";
        } else {
            budgetImpact.textContent = "$" + Math.abs(remaining).toFixed(2) + " over budget";
            budgetImpact.className = "text-xs text-rose-400";
        }
    });

    // Character count for description
    if (descriptionTextarea) {
        descriptionTextarea.addEventListener('input', function() {
            const length = this.value.length;
            charCount.textContent = length + '/500';
            if (length > 450) {
                charCount.classList.remove('text-slate-500');
                charCount.classList.add('text-amber-400');
            } else if (length > 480) {
                charCount.classList.remove('text-amber-400');
                charCount.classList.add('text-rose-400');
            } else {
                charCount.classList.remove('text-amber-400', 'text-rose-400');
                charCount.classList.add('text-slate-500');
            }
        });

        // Trigger initial count
        descriptionTextarea.dispatchEvent(new Event('input'));
    }

    // Trigger amount input for initial budget impact
    amountInput.dispatchEvent(new Event('input'));
});

function setCategory(category) {
    const nameInput = document.querySelector('input[name="name"]');
    const currentValue = nameInput.value.toLowerCase();

    // Remove existing category from name if present
    const categories = ['business', 'personal', 'investment', 'other'];
    let cleanName = currentValue;
    categories.forEach(cat => {
        cleanName = cleanName.replace(cat, '').trim();
    });

    // Add new category
    nameInput.value = cleanName + (cleanName ? ' ' : '') + category;
    document.getElementById('categoryInput').value = category;

    // Visual feedback
    document.querySelectorAll('.category-option').forEach(opt => {
        opt.classList.remove('ring-2', 'ring-rose-500');
    });
    event.currentTarget.classList.add('ring-2', 'ring-rose-500');
}

function setAmount(amount) {
    const amountInput = document.getElementById('amountInput');
    amountInput.value = amount;
    amountInput.dispatchEvent(new Event('input'));
}

function setTodayDate() {
    const now = new Date();
    const today = now.toISOString().slice(0, 16);
    const dateInput = document.querySelector('input[name="date"]');
    dateInput.value = today;
}

function clearForm() {
    if (confirm('Are you sure you want to clear all form fields?')) {
        document.getElementById('expenseForm').reset();
        document.getElementById('categoryInput').value = '';
        document.getElementById('budgetImpact').textContent = '';
        document.getElementById('charCount').textContent = '0/500';

        // Reset category buttons
        document.querySelectorAll('.category-option').forEach(opt => {
            opt.classList.remove('ring-2', 'ring-rose-500');
        });
    }
}

// Form validation
document.getElementById('expenseForm').addEventListener('submit', function(e) {
    const amountInput = document.getElementById('amountInput');
    const amount = parseFloat(amountInput.value);

    if (isNaN(amount) || amount <= 0) {
        e.preventDefault();
        alert('Please enter a valid amount greater than 0.');
        amountInput.focus();
        return false;
    }
});
</script>
{% endblock %}